require('dotenv').config({ path: '.env.local' });
const { createClient } = require('@supabase/supabase-js');

// í™˜ê²½ ë³€ìˆ˜ì—ì„œ Supabase ì •ë³´ ê°€ì ¸ì˜¤ê¸°
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('âŒ Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
  console.log('NEXT_PUBLIC_SUPABASE_URL:', supabaseUrl ? 'ì„¤ì •ë¨' : 'ì„¤ì •ë˜ì§€ ì•ŠìŒ');
  console.log('SUPABASE_SERVICE_ROLE_KEY:', supabaseServiceKey ? 'ì„¤ì •ë¨' : 'ì„¤ì •ë˜ì§€ ì•ŠìŒ');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

async function createAITable() {
  try {
    console.log('ğŸ—„ï¸ AI ì‚¬ìš©ëŸ‰ í…Œì´ë¸” ìƒì„± ì‹œì‘...');

    // í…Œì´ë¸”ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    const { data: existingTables, error: checkError } = await supabase
      .from('information_schema.tables')
      .select('table_name')
      .eq('table_schema', 'public')
      .eq('table_name', 'ai_usage_logs');

    if (checkError) {
      console.log('âš ï¸ í…Œì´ë¸” í™•ì¸ ì¤‘ ì˜¤ë¥˜ (ì •ìƒì¼ ìˆ˜ ìˆìŒ):', checkError.message);
    }

    if (existingTables && existingTables.length > 0) {
      console.log('âœ… AI ì‚¬ìš©ëŸ‰ í…Œì´ë¸”ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
      return;
    }

    // í…Œì´ë¸” ìƒì„± SQL
    const createTableSQL = `
      CREATE TABLE IF NOT EXISTS public.ai_usage_logs (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        api_endpoint TEXT NOT NULL,
        model TEXT NOT NULL,
        input_tokens INTEGER DEFAULT 0,
        output_tokens INTEGER DEFAULT 0,
        total_tokens INTEGER DEFAULT 0,
        cost DECIMAL(10, 6) DEFAULT 0,
        improvement_type TEXT,
        content_type TEXT,
        user_agent TEXT,
        ip_address INET,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
      );
    `;

    // SQL ì‹¤í–‰ì„ ìœ„í•´ ì§ì ‘ ì¿¼ë¦¬ ì‹¤í–‰
    const { error: createError } = await supabase
      .rpc('exec', { sql: createTableSQL });

    if (createError) {
      console.error('âŒ í…Œì´ë¸” ìƒì„± ì—ëŸ¬:', createError);
      
      // ëŒ€ì•ˆ: ì§ì ‘ INSERTë¡œ í…Œì´ë¸” êµ¬ì¡° í™•ì¸
      console.log('ğŸ”„ ëŒ€ì•ˆ ë°©ë²•ìœ¼ë¡œ í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸...');
      
      try {
        const { error: testError } = await supabase
          .from('ai_usage_logs')
          .select('id')
          .limit(1);
        
        if (!testError) {
          console.log('âœ… AI ì‚¬ìš©ëŸ‰ í…Œì´ë¸”ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
          return;
        } else {
          console.log('âŒ í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.');
          console.log('ğŸ“‹ ë‹¤ìŒ SQLì„ Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”:');
          console.log(createTableSQL);
        }
      } catch (testError) {
        console.log('âŒ í…Œì´ë¸” ì ‘ê·¼ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', testError.message);
      }
    } else {
      console.log('âœ… AI ì‚¬ìš©ëŸ‰ í…Œì´ë¸”ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ì¸ë±ìŠ¤ ìƒì„±
    const indexes = [
      'CREATE INDEX IF NOT EXISTS idx_ai_usage_logs_endpoint ON public.ai_usage_logs (api_endpoint);',
      'CREATE INDEX IF NOT EXISTS idx_ai_usage_logs_model ON public.ai_usage_logs (model);',
      'CREATE INDEX IF NOT EXISTS idx_ai_usage_logs_created_at ON public.ai_usage_logs (created_at DESC);',
      'CREATE INDEX IF NOT EXISTS idx_ai_usage_logs_cost ON public.ai_usage_logs (cost DESC);'
    ];

    for (const indexSQL of indexes) {
      try {
        const { error: indexError } = await supabase.rpc('exec', { sql: indexSQL });
        if (indexError) {
          console.log('âš ï¸ ì¸ë±ìŠ¤ ìƒì„± ê²½ê³ :', indexError.message);
        } else {
          console.log('âœ… ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ');
        }
      } catch (indexError) {
        console.log('âš ï¸ ì¸ë±ìŠ¤ ìƒì„± ì¤‘ ì˜¤ë¥˜:', indexError.message);
      }
    }

    // RLS ì •ì±… ì„¤ì •
    const policies = [
      'ALTER TABLE public.ai_usage_logs ENABLE ROW LEVEL SECURITY;',
      'CREATE POLICY IF NOT EXISTS "Enable read access for all users" ON public.ai_usage_logs FOR SELECT USING (TRUE);',
      'CREATE POLICY IF NOT EXISTS "Enable insert access for service role" ON public.ai_usage_logs FOR INSERT WITH CHECK (TRUE);'
    ];

    for (const policySQL of policies) {
      try {
        const { error: policyError } = await supabase.rpc('exec', { sql: policySQL });
        if (policyError) {
          console.log('âš ï¸ ì •ì±… ì„¤ì • ê²½ê³ :', policyError.message);
        } else {
          console.log('âœ… ì •ì±… ì„¤ì • ì™„ë£Œ');
        }
      } catch (policyError) {
        console.log('âš ï¸ ì •ì±… ì„¤ì • ì¤‘ ì˜¤ë¥˜:', policyError.message);
      }
    }

  } catch (error) {
    console.error('âŒ í…Œì´ë¸” ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
  }
}

// ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
createAITable().then(() => {
  console.log('ğŸ AI ì‚¬ìš©ëŸ‰ í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ');
  process.exit(0);
}).catch((error) => {
  console.error('âŒ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
  process.exit(1);
});
