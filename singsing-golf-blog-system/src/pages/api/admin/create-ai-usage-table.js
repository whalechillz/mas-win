import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('âŒ Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

export default async function handler(req, res) {
  console.log('ğŸ—„ï¸ AI ì‚¬ìš©ëŸ‰ í…Œì´ë¸” ìƒì„± API ìš”ì²­:', req.method);

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  if (!supabaseUrl || !supabaseServiceKey) {
    console.error('âŒ Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
    return res.status(500).json({ error: 'ì„œë²„ ì„¤ì • ì˜¤ë¥˜' });
  }

  try {
    // AI ì‚¬ìš©ëŸ‰ ë¡œê·¸ í…Œì´ë¸” ìƒì„±
    const createTableSQL = `
      CREATE TABLE IF NOT EXISTS public.ai_usage_logs (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        api_endpoint TEXT NOT NULL,
        model TEXT NOT NULL,
        input_tokens INTEGER DEFAULT 0,
        output_tokens INTEGER DEFAULT 0,
        total_tokens INTEGER DEFAULT 0,
        cost DECIMAL(10, 6) DEFAULT 0,
        improvement_type TEXT,
        content_type TEXT,
        user_agent TEXT,
        ip_address INET,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
      );
    `;

    // ì¸ë±ìŠ¤ ìƒì„±
    const createIndexesSQL = [
      `CREATE INDEX IF NOT EXISTS idx_ai_usage_logs_endpoint ON public.ai_usage_logs (api_endpoint);`,
      `CREATE INDEX IF NOT EXISTS idx_ai_usage_logs_model ON public.ai_usage_logs (model);`,
      `CREATE INDEX IF NOT EXISTS idx_ai_usage_logs_created_at ON public.ai_usage_logs (created_at DESC);`,
      `CREATE INDEX IF NOT EXISTS idx_ai_usage_logs_cost ON public.ai_usage_logs (cost DESC);`
    ];

    // RLS ì •ì±… ì„¤ì •
    const createPoliciesSQL = [
      `ALTER TABLE public.ai_usage_logs ENABLE ROW LEVEL SECURITY;`,
      `DROP POLICY IF EXISTS "Enable read access for all users" ON public.ai_usage_logs;`,
      `CREATE POLICY "Enable read access for all users" ON public.ai_usage_logs FOR SELECT USING (TRUE);`,
      `DROP POLICY IF EXISTS "Enable insert access for service role" ON public.ai_usage_logs;`,
      `CREATE POLICY "Enable insert access for service role" ON public.ai_usage_logs FOR INSERT WITH CHECK (TRUE);`
    ];

    // í†µê³„ ë·° ìƒì„±
    const createViewsSQL = [
      `CREATE OR REPLACE VIEW public.ai_usage_stats AS
       SELECT 
         api_endpoint,
         model,
         COUNT(*) as total_requests,
         SUM(total_tokens) as total_tokens,
         SUM(cost) as total_cost,
         AVG(cost) as avg_cost_per_request,
         DATE_TRUNC('day', created_at) as usage_date
       FROM public.ai_usage_logs
       GROUP BY api_endpoint, model, DATE_TRUNC('day', created_at)
       ORDER BY usage_date DESC;`,
      
      `CREATE OR REPLACE VIEW public.ai_usage_monthly_stats AS
       SELECT 
         api_endpoint,
         model,
         COUNT(*) as total_requests,
         SUM(total_tokens) as total_tokens,
         SUM(cost) as total_cost,
         AVG(cost) as avg_cost_per_request,
         DATE_TRUNC('month', created_at) as usage_month
       FROM public.ai_usage_logs
       GROUP BY api_endpoint, model, DATE_TRUNC('month', created_at)
       ORDER BY usage_month DESC;`
    ];

    console.log('ğŸ—„ï¸ AI ì‚¬ìš©ëŸ‰ í…Œì´ë¸” ìƒì„± ì‹œì‘...');

    // í…Œì´ë¸” ìƒì„±
    const { error: tableError } = await supabase.rpc('exec_sql', { sql: createTableSQL });
    if (tableError) {
      console.error('âŒ í…Œì´ë¸” ìƒì„± ì—ëŸ¬:', tableError);
      return res.status(500).json({ error: 'í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨', details: tableError.message });
    }

    // ì¸ë±ìŠ¤ ìƒì„±
    for (const indexSQL of createIndexesSQL) {
      const { error: indexError } = await supabase.rpc('exec_sql', { sql: indexSQL });
      if (indexError) {
        console.log('âš ï¸ ì¸ë±ìŠ¤ ìƒì„± ê²½ê³ :', indexError.message);
      }
    }

    // RLS ì •ì±… ì„¤ì •
    for (const policySQL of createPoliciesSQL) {
      const { error: policyError } = await supabase.rpc('exec_sql', { sql: policySQL });
      if (policyError) {
        console.log('âš ï¸ ì •ì±… ì„¤ì • ê²½ê³ :', policyError.message);
      }
    }

    // ë·° ìƒì„±
    for (const viewSQL of createViewsSQL) {
      const { error: viewError } = await supabase.rpc('exec_sql', { sql: viewSQL });
      if (viewError) {
        console.log('âš ï¸ ë·° ìƒì„± ê²½ê³ :', viewError.message);
      }
    }

    console.log('âœ… AI ì‚¬ìš©ëŸ‰ í…Œì´ë¸” ìƒì„± ì™„ë£Œ');

    // í…Œì´ë¸” ì¡´ì¬ í™•ì¸
    const { data: tables, error: checkError } = await supabase
      .from('information_schema.tables')
      .select('table_name')
      .eq('table_schema', 'public')
      .eq('table_name', 'ai_usage_logs');

    if (checkError) {
      console.log('âš ï¸ í…Œì´ë¸” í™•ì¸ ê²½ê³ :', checkError.message);
    }

    return res.status(200).json({ 
      success: true, 
      message: 'AI ì‚¬ìš©ëŸ‰ í…Œì´ë¸”ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      tableExists: tables && tables.length > 0
    });

  } catch (error) {
    console.error('âŒ AI ì‚¬ìš©ëŸ‰ í…Œì´ë¸” ìƒì„± API ì˜¤ë¥˜:', error);
    return res.status(500).json({ 
      error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 
      details: error.message 
    });
  }
}
