<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASGOLF Slack 알림 디버깅</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">🔧 MASGOLF Slack 알림 디버깅</h1>
        
        <!-- 설정 확인 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">📋 현재 설정</h2>
            <div id="configStatus" class="space-y-2">
                <p class="text-gray-600">설정을 확인하는 중...</p>
            </div>
        </div>

        <!-- API 테스트 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">🚀 API 테스트</h2>
            <button onclick="testSlackAPI()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                /api/slack-test 엔드포인트 테스트
            </button>
            <div id="apiResult" class="mt-4 p-4 bg-gray-100 rounded hidden">
                <pre class="text-sm"></pre>
            </div>
        </div>

        <!-- 예약 알림 테스트 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">📅 예약 알림 테스트</h2>
            <form id="bookingTestForm" class="space-y-4">
                <input type="text" name="name" placeholder="이름" value="테스트 고객" 
                       class="w-full p-2 border rounded">
                <input type="tel" name="phone" placeholder="전화번호" value="010-1234-5678" 
                       class="w-full p-2 border rounded">
                <input type="date" name="date" value="2025-07-15" 
                       class="w-full p-2 border rounded">
                <select name="time" class="w-full p-2 border rounded">
                    <option value="14:00">오후 2시</option>
                    <option value="15:00">오후 3시</option>
                </select>
                <select name="club" class="w-full p-2 border rounded">
                    <option value="시크리트포스 PRO 3">시크리트포스 PRO 3</option>
                    <option value="시크리트웨폰 블랙">시크리트웨폰 블랙</option>
                </select>
                <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    예약 알림 보내기
                </button>
            </form>
            <div id="bookingResult" class="mt-4 p-4 bg-gray-100 rounded hidden">
                <pre class="text-sm"></pre>
            </div>
        </div>

        <!-- 문의 알림 테스트 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">💬 문의 알림 테스트</h2>
            <form id="contactTestForm" class="space-y-4">
                <input type="text" name="name" placeholder="이름" value="문의 고객" 
                       class="w-full p-2 border rounded">
                <input type="tel" name="phone" placeholder="전화번호" value="010-9876-5432" 
                       class="w-full p-2 border rounded">
                <input type="text" name="call_times" placeholder="통화 가능 시간" value="오전 10시, 오후 2시" 
                       class="w-full p-2 border rounded">
                <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    문의 알림 보내기
                </button>
            </form>
            <div id="contactResult" class="mt-4 p-4 bg-gray-100 rounded hidden">
                <pre class="text-sm"></pre>
            </div>
        </div>

        <!-- 직접 웹훅 테스트 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">🔗 직접 웹훅 테스트 (클라이언트)</h2>
            <p class="text-sm text-red-500 mb-4">⚠️ 주의: 이 방법은 CORS 에러가 발생할 수 있습니다.</p>
            <button onclick="testDirectWebhook()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                클라이언트에서 직접 웹훅 호출
            </button>
            <div id="directResult" class="mt-4 p-4 bg-gray-100 rounded hidden">
                <pre class="text-sm"></pre>
            </div>
        </div>

        <!-- 로그 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold mb-4">📝 디버그 로그</h2>
            <div id="debugLog" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm overflow-auto max-h-96">
                <p>대기 중...</p>
            </div>
            <button onclick="clearLog()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                로그 지우기
            </button>
        </div>
    </div>

    <script>
        let logContent = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-gray-400';
            logContent.push(`<span class="${color}">[${timestamp}] ${message}</span>`);
            document.getElementById('debugLog').innerHTML = logContent.join('<br>');
            document.getElementById('debugLog').scrollTop = document.getElementById('debugLog').scrollHeight;
        }
        
        function clearLog() {
            logContent = [];
            document.getElementById('debugLog').innerHTML = '<p>로그가 지워졌습니다.</p>';
        }
        
        // 설정 확인
        window.onload = function() {
            const configStatus = document.getElementById('configStatus');
            let html = '';
            
            if (typeof SUPABASE_CONFIG !== 'undefined') {
                html += '<p class="text-green-600">✅ SUPABASE_CONFIG 로드됨</p>';
                html += `<p class="text-gray-600 ml-4">- URL: ${SUPABASE_CONFIG.url.substring(0, 30)}...</p>`;
                html += `<p class="text-gray-600 ml-4">- Anon Key: ${SUPABASE_CONFIG.anonKey.substring(0, 30)}...</p>`;
                
                if (SUPABASE_CONFIG.slackWebhook && SUPABASE_CONFIG.slackWebhook !== 'YOUR_SLACK_WEBHOOK_URL_FOR_01-ma-op') {
                    html += '<p class="text-green-600">✅ Slack Webhook 설정됨</p>';
                    html += `<p class="text-gray-600 ml-4">- Webhook: ${SUPABASE_CONFIG.slackWebhook.substring(0, 50)}...</p>`;
                } else {
                    html += '<p class="text-red-600">❌ Slack Webhook 설정 안 됨</p>';
                }
            } else {
                html += '<p class="text-red-600">❌ SUPABASE_CONFIG를 찾을 수 없음</p>';
            }
            
            configStatus.innerHTML = html;
            log('페이지 로드 완료');
        };
        
        // API 테스트
        async function testSlackAPI() {
            log('API 테스트 시작...');
            const resultDiv = document.getElementById('apiResult');
            resultDiv.classList.remove('hidden');
            resultDiv.querySelector('pre').textContent = '요청 중...';
            
            try {
                const response = await fetch('/api/slack-test');
                const data = await response.json();
                
                resultDiv.querySelector('pre').textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    log('API 테스트 성공!', 'success');
                } else {
                    log(`API 테스트 실패: ${data.error}`, 'error');
                }
            } catch (error) {
                resultDiv.querySelector('pre').textContent = `Error: ${error.message}`;
                log(`API 테스트 에러: ${error.message}`, 'error');
            }
        }
        
        // 예약 알림 테스트
        document.getElementById('bookingTestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            log('예약 알림 테스트 시작...');
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            const resultDiv = document.getElementById('bookingResult');
            resultDiv.classList.remove('hidden');
            resultDiv.querySelector('pre').textContent = '요청 중...';
            
            try {
                const response = await fetch('/api/slack/notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'booking',
                        data: data
                    })
                });
                
                const result = await response.json();
                resultDiv.querySelector('pre').textContent = JSON.stringify(result, null, 2);
                
                if (result.success) {
                    log('예약 알림 전송 성공!', 'success');
                } else {
                    log(`예약 알림 전송 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                resultDiv.querySelector('pre').textContent = `Error: ${error.message}`;
                log(`예약 알림 에러: ${error.message}`, 'error');
            }
        });
        
        // 문의 알림 테스트
        document.getElementById('contactTestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            log('문의 알림 테스트 시작...');
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            const resultDiv = document.getElementById('contactResult');
            resultDiv.classList.remove('hidden');
            resultDiv.querySelector('pre').textContent = '요청 중...';
            
            try {
                const response = await fetch('/api/slack/notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'contact',
                        data: data
                    })
                });
                
                const result = await response.json();
                resultDiv.querySelector('pre').textContent = JSON.stringify(result, null, 2);
                
                if (result.success) {
                    log('문의 알림 전송 성공!', 'success');
                } else {
                    log(`문의 알림 전송 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                resultDiv.querySelector('pre').textContent = `Error: ${error.message}`;
                log(`문의 알림 에러: ${error.message}`, 'error');
            }
        });
        
        // 직접 웹훅 테스트
        async function testDirectWebhook() {
            log('직접 웹훅 테스트 시작...');
            
            const resultDiv = document.getElementById('directResult');
            resultDiv.classList.remove('hidden');
            resultDiv.querySelector('pre').textContent = '요청 중...';
            
            if (!SUPABASE_CONFIG || !SUPABASE_CONFIG.slackWebhook || 
                SUPABASE_CONFIG.slackWebhook === 'YOUR_SLACK_WEBHOOK_URL_FOR_01-ma-op') {
                resultDiv.querySelector('pre').textContent = 'Error: Slack Webhook URL이 설정되지 않았습니다.';
                log('Slack Webhook URL이 설정되지 않음', 'error');
                return;
            }
            
            try {
                log(`웹훅 URL: ${SUPABASE_CONFIG.slackWebhook.substring(0, 50)}...`);
                
                const response = await fetch(SUPABASE_CONFIG.slackWebhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: '🧪 디버그 테스트: 클라이언트에서 직접 보낸 메시지입니다!'
                    })
                });
                
                const result = await response.text();
                resultDiv.querySelector('pre').textContent = `Status: ${response.status}\nResponse: ${result}`;
                
                if (response.ok) {
                    log('직접 웹훅 테스트 성공!', 'success');
                } else {
                    log(`직접 웹훅 테스트 실패: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.querySelector('pre').textContent = `Error: ${error.message}\n\n주의: CORS 에러가 발생했다면 서버 API를 통해 테스트하세요.`;
                log(`직접 웹훅 에러: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>