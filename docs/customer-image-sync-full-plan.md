# 고객 이미지 Storage 동기화 전체 계획서 (2993명)

## 📋 문서 정보
- **작성일**: 2026-01-28
- **대상**: 전체 고객 2,993명
- **목적**: Storage와 DB 메타데이터 동기화, 고스트 이미지 및 중복 이미지 제거

---

## 1. 배경 및 문제 정의

### 1.1 발견된 문제

이남구 고객에서 발견된 문제를 전체 고객으로 확장 조사한 결과:

**이남구 고객 사례:**
- DB 메타데이터: 24개
- Storage 실제 파일: 11개
- 중복 이미지: 13개 (같은 filename이 여러 번 등록)
- 고스트 이미지: 0개

**박성우 고객 사례:**
- DB 메타데이터: 20개
- Storage 실제 파일: 16개
- 중복 이미지: 0개 (날짜가 다르면 같은 filename도 다른 이미지)
- 고스트 이미지: 4개 (.heic 파일, Storage에 없음)

### 1.2 문제 유형

#### 1.2.1 고스트 이미지 (Ghost Images)
- **정의**: DB에 메타데이터는 있지만 Storage에 실제 파일이 없는 이미지
- **원인**:
  - 파일이 삭제되었지만 DB 메타데이터가 남아있음
  - `file_path`가 잘못되어 실제 파일과 매칭되지 않음
  - 날짜 폴더로만 끝나고 실제 파일명이 없는 경우
- **영향**: 
  - 고객 관리에서 이미지 로드 실패
  - 잘못된 이미지 개수 표시
  - 사용자 혼란

#### 1.2.2 중복 이미지 (Duplicate Images)
- **정의**: 같은 `file_path`(날짜 포함)를 가진 여러 개의 DB 메타데이터
- **주의**: 같은 `filename`이라도 날짜가 다르면 다른 이미지임
  - 예: `parksungwoo_s5_art-wall_01.webp`가 `2024-09-09`와 `2024-10-15`에 각각 존재
  - 파일 크기가 다르므로 실제로 다른 이미지
- **원인**:
  - 이미지 업로드 시 중복 등록
  - 마이그레이션 과정에서 중복 생성
- **영향**: 고객 관리에서 이미지 개수가 실제보다 많게 표시

#### 1.2.3 썸네일/리사이즈 파일
- **정의**: Storage에 존재하지만 원본 파일이 아닌 생성된 파일
- **원인**: 이미지 처리 과정에서 자동 생성
- **영향**: Storage 용량 낭비

---

## 2. 목표

1. **데이터 일관성**: Storage 실제 파일과 DB 메타데이터 일치
2. **정확한 이미지 개수**: 고객 관리에서 실제 이미지 개수 표시
3. **Storage 최적화**: 불필요한 고스트 이미지 메타데이터 제거
4. **사용자 경험 개선**: 이미지 로드 실패 최소화

---

## 3. 기술적 접근

### 3.1 중복 판단 기준

**❌ 잘못된 방법 (이전):**
- `filename`만으로 중복 판단
- 문제: 날짜가 다른 경우 같은 filename도 다른 이미지일 수 있음

**✅ 올바른 방법 (수정 후):**
- `file_path` 전체(날짜 포함)로 중복 판단
- 예: 
  - `originals/customers/parksungwoo-6003/2024-09-09/parksungwoo_s5_art-wall_01.webp`
  - `originals/customers/parksungwoo-6003/2024-10-15/parksungwoo_s5_art-wall_01.webp`
  - → 다른 이미지로 처리

### 3.2 매칭 로직

```javascript
// 1. file_path가 날짜 폴더로만 끝나는 경우 처리
let actualPath = filePath;
if (/\/\d{4}-\d{2}-\d{2}$/.test(filePath) && filename) {
  actualPath = `${filePath}/${filename}`;
}

// 2. Storage 파일 경로와 정확히 매칭
if (storageFilePathMap.has(actualPath.toLowerCase())) {
  // Storage에 존재 → 유효한 이미지
} else {
  // Storage에 없음 → 고스트 이미지
}
```

### 3.3 중복 처리 로직

```javascript
// 같은 file_path에 여러 메타데이터가 있는 경우
if (images.length > 1) {
  // 가장 최근 것만 유지
  const sorted = images.sort((a, b) => 
    new Date(b.created_at) - new Date(a.created_at)
  );
  toKeep.push(sorted[0]);
  toDelete.push(...sorted.slice(1)); // 나머지는 중복
}
```

---

## 4. 실행 계획

### Phase 1: 전체 현황 파악 ✅

**기간**: 1일차

**작업**:
1. ✅ 전체 고객 확인 스크립트 작성
2. ✅ 2,993명 고객 스캔 실행
3. ✅ 문제가 있는 고객 목록 및 통계 생성
4. ✅ 보고서 생성: `customer-ghost-images-report.json`

**스크립트**:
- `scripts/check-all-customers-ghost-images.js`

**결과물**:
- 문제가 있는 고객 목록
- 고스트 이미지 통계
- 중복 이미지 통계
- 문제 유형별 분류

### Phase 2: 스크립트 개발 및 검증 ✅

**기간**: 1일차

**작업**:
1. ✅ 동기화 스크립트 작성
2. ✅ file_path 기반 정확한 매칭 로직 구현
3. ✅ DRY RUN 모드 검증
4. ✅ 박성우 고객 사례 검증

**스크립트**:
- `scripts/sync-all-customers-images.js` - 일괄 동기화
- `scripts/check-parksungwoo-by-date.js` - 날짜별 상세 확인

**검증 결과**:
- ✅ 박성우 고객: 날짜가 다른 경우 같은 filename도 다른 이미지로 정확히 처리
- ✅ file_path 기반 매칭 로직 정확성 확인

### Phase 3: 소규모 테스트 (예정)

**기간**: 2일차

**목표**: 안전성 검증

**작업**:
1. 문제가 적은 고객 10명 선별
2. DRY RUN 실행
3. 결과 검증
4. 실제 실행
5. 결과 모니터링

**선별 기준**:
- 고스트 이미지 1-2개
- 중복 이미지 0-1개
- 문제가 명확한 경우

### Phase 4: 중규모 실행 (예정)

**기간**: 2일차

**목표**: 안정성 확인

**작업**:
1. 문제가 중간인 고객 50명 선별
2. 배치 처리 (10명씩)
3. 각 배치마다 결과 확인
4. 문제 발생 시 즉시 중단

### Phase 5: 대규모 실행 (예정)

**기간**: 3일차

**목표**: 전체 동기화

**작업**:
1. 나머지 모든 고객 처리
2. 배치 처리 (10명씩)
3. 진행 상황 모니터링
4. 오류 로그 기록

### Phase 6: 검증 및 모니터링 (예정)

**기간**: 3일차

**작업**:
1. 동기화 후 재확인 스크립트 실행
2. 고객 관리 UI에서 이미지 개수 확인
3. 이미지 로드 실패 확인
4. 문제 발생 시 롤백

---

## 5. 스크립트 목록

### 5.1 확인 스크립트

#### `check-all-customers-ghost-images.js`
- **목적**: 전체 고객의 고스트 이미지 및 중복 이미지 확인
- **기능**:
  - 2,993명 고객 전체 스캔 (페이지네이션)
  - Storage 실제 파일과 DB 메타데이터 비교
  - file_path 기반 정확한 매칭
  - 문제가 있는 고객 목록 생성
  - 통계 및 보고서 생성
- **출력**: `customer-ghost-images-report.json`

#### `check-parksungwoo-by-date.js`
- **목적**: 특정 고객의 날짜별 상세 확인
- **기능**:
  - 날짜별로 그룹화하여 확인
  - 같은 filename이 다른 날짜에 있는 경우 확인
  - 파일 크기 비교로 실제 다른 이미지인지 확인

#### `check-customer-image-sync.js`
- **목적**: 특정 고객의 동기화 상태 확인
- **사용법**: `node scripts/check-customer-image-sync.js <folder_name>`

### 5.2 정리 스크립트

#### `sync-all-customers-images.js`
- **목적**: 모든 고객의 이미지 일괄 동기화
- **기능**:
  - 보고서 파일에서 문제가 있는 고객만 처리
  - file_path 기반 정확한 매칭
  - 고스트 이미지 삭제
  - 중복 이미지 삭제 (같은 file_path에 여러 메타데이터)
  - 배치 처리 (기본 10명씩)
  - 백업 자동 생성
- **사용법**:
  ```bash
  # DRY RUN
  node scripts/sync-all-customers-images.js
  
  # 실제 실행
  node scripts/sync-all-customers-images.js --execute
  
  # 작은 배치 크기
  node scripts/sync-all-customers-images.js --execute --batch=5
  ```

#### `sync-customer-images.js`
- **목적**: 특정 고객의 이미지 동기화
- **사용법**: `node scripts/sync-customer-images.js <folder_name> --execute`

### 5.3 유틸리티 스크립트

#### `backup-image-metadata.js`
- **목적**: DB 메타데이터 백업
- **기능**: 삭제 전 모든 이미지 메타데이터 백업

#### `restore-image-metadata.js`
- **목적**: DB 메타데이터 복원
- **기능**: 백업 파일에서 메타데이터 복원

---

## 6. 안전장치

### 6.1 DRY RUN 모드
- 모든 스크립트는 기본적으로 시뮬레이션만 수행
- 실제 삭제 없이 결과만 확인
- `--execute` 옵션으로 실제 실행

### 6.2 백업
- 삭제 전 모든 이미지 메타데이터 자동 백업
- 백업 파일: `image-sync-backup-YYYY-MM-DD.json`
- 삭제된 이미지 ID, 고객 정보, 삭제 시간 기록

### 6.3 단계별 실행
- 소규모(10명) → 중규모(50명) → 대규모(나머지)
- 각 단계마다 결과 검증
- 문제 발생 시 즉시 중단

### 6.4 배치 처리
- 한 번에 10명씩 처리 (기본값)
- DB 부하 최소화
- 배치 간 1초 대기

### 6.5 로깅
- 모든 삭제 작업 상세 기록
- 오류 발생 시 즉시 로그 출력
- 진행 상황 실시간 표시

### 6.6 롤백
- 삭제된 이미지 ID 기록
- 백업 파일에서 복원 가능
- 문제 발생 시 즉시 복원

---

## 7. 예상 결과

### 7.1 정량적 효과

**현재 추정 (1000명 샘플 기준)**:
- 문제가 있는 고객: 16명 (1.6%)
- 고스트 이미지: 72개
- 중복 이미지: 21개

**전체 2,993명 추정**:
- 문제가 있는 고객: 약 48명 (1.6%)
- 고스트 이미지: 약 215개
- 중복 이미지: 약 63개

**동기화 후**:
- 고스트 이미지: 0개
- 중복 이미지: 0개
- Storage와 DB 일치율: 100%

### 7.2 정성적 효과

- **데이터 일관성**: Storage와 DB 완전 동기화
- **정확한 개수**: 고객 관리에서 실제 이미지 개수 표시
- **사용자 경험**: 이미지 로드 실패 최소화
- **유지보수성**: 깨끗한 데이터베이스

---

## 8. 리스크 및 대응

### 8.1 리스크

#### 리스크 1: 실제 파일이 있는데 고스트로 판단
- **원인**: 파일명 매칭 오류, 경로 불일치
- **대응**: 
  - file_path 전체 경로로 매칭
  - 날짜 폴더 + filename 조합 확인
  - 엄격한 매칭 로직

#### 리스크 2: 중요한 이미지 삭제
- **원인**: 잘못된 중복 판단
- **대응**: 
  - file_path 전체로 중복 판단 (날짜 포함)
  - 같은 file_path에 여러 메타데이터만 중복으로 처리
  - 보수적 접근: 확실한 경우만 삭제

#### 리스크 3: 대량 삭제로 인한 DB 부하
- **원인**: 한 번에 너무 많이 삭제
- **대응**: 
  - 배치 처리 (10명씩)
  - 배치 간 대기 시간
  - 점진적 실행

#### 리스크 4: 날짜가 다른 같은 filename을 중복으로 판단
- **원인**: filename만으로 중복 판단
- **대응**: ✅ **수정 완료** - file_path 전체로 판단

### 8.2 대응 계획

1. **엄격한 매칭 로직**: file_path 전체 경로로 매칭
2. **보수적 접근**: 확실한 경우만 삭제, 의심스러우면 보존
3. **배치 처리**: 한 번에 너무 많이 삭제하지 않음
4. **백업 및 롤백**: 문제 발생 시 즉시 복원

---

## 9. 실행 일정

### 9.1 전체 일정

- **1일차 (완료)**: 현황 파악 및 스크립트 개발 ✅
- **2일차 (예정)**: 소규모 테스트 및 중규모 실행
- **3일차 (예정)**: 대규모 실행 및 검증

### 9.2 상세 일정

#### 1일차 (2026-01-28) ✅
- [x] 전체 고객 확인 스크립트 작성
- [x] file_path 기반 매칭 로직 구현
- [x] 박성우 고객 사례 검증
- [x] 동기화 스크립트 작성
- [x] 계획서 작성

#### 2일차 (예정)
- [ ] 전체 고객 재확인 (2,993명)
- [ ] 소규모 테스트 (10명)
- [ ] 결과 검증
- [ ] 중규모 실행 (50명)

#### 3일차 (예정)
- [ ] 대규모 실행 (나머지)
- [ ] 최종 검증
- [ ] 모니터링

---

## 10. 실행 방법

### 10.1 전체 현황 확인

```bash
# 전체 고객 확인 (2,993명)
node scripts/check-all-customers-ghost-images.js

# 결과 확인
cat scripts/customer-ghost-images-report.json
```

### 10.2 동기화 실행

```bash
# 1. DRY RUN (시뮬레이션)
node scripts/sync-all-customers-images.js

# 2. 소규모 테스트 (10명)
node scripts/sync-all-customers-images.js --execute --batch=5

# 3. 중규모 실행 (50명)
node scripts/sync-all-customers-images.js --execute --batch=10

# 4. 대규모 실행 (전체)
node scripts/sync-all-customers-images.js --execute
```

### 10.3 특정 고객 확인/정리

```bash
# 특정 고객 확인
node scripts/check-parksungwoo-by-date.js

# 특정 고객 정리
node scripts/sync-customer-images.js parksungwoo-6003 --execute
```

---

## 11. 검증 방법

### 11.1 동기화 후 확인

```bash
# 전체 재확인
node scripts/check-all-customers-ghost-images.js

# 결과 확인
# - 문제가 있는 고객: 0명
# - 고스트 이미지: 0개
# - 중복 이미지: 0개
```

### 11.2 UI 확인

1. 고객 관리 페이지 접속
2. 문제가 있던 고객 확인
3. 이미지 개수 확인 (Storage와 일치하는지)
4. 이미지 로드 실패 확인

### 11.3 백업 확인

```bash
# 백업 파일 확인
ls -lh scripts/image-sync-backup-*.json

# 백업 내용 확인
cat scripts/image-sync-backup-YYYY-MM-DD.json
```

---

## 12. 롤백 계획

### 12.1 문제 발생 시

1. **즉시 중단**: 실행 중인 스크립트 중단
2. **백업 확인**: 최신 백업 파일 확인
3. **복원 실행**: `restore-image-metadata.js` 실행
4. **검증**: 복원 후 재확인

### 12.2 복원 방법

```bash
# 백업 파일에서 복원
node scripts/restore-image-metadata.js scripts/image-sync-backup-YYYY-MM-DD.json
```

---

## 13. 모니터링

### 13.1 실행 중 모니터링

- 진행 상황 로그 확인
- 오류 발생 시 즉시 확인
- 각 배치마다 결과 확인

### 13.2 실행 후 모니터링

- 전체 재확인 스크립트 실행
- UI에서 이미지 개수 확인
- 이미지 로드 실패 확인
- 사용자 피드백 수집

---

## 14. 참고 문서

- `docs/customer-image-sync-plan.md` - 초기 계획서
- `scripts/customer-ghost-images-report.json` - 확인 결과 보고서
- `scripts/image-sync-backup-*.json` - 백업 파일

---

## 15. 체크리스트

### Phase 1: 현황 파악 ✅
- [x] 전체 고객 확인 스크립트 작성
- [x] file_path 기반 매칭 로직 구현
- [x] 박성우 고객 사례 검증
- [ ] 전체 2,993명 확인 실행

### Phase 2: 스크립트 개발 ✅
- [x] 동기화 스크립트 작성
- [x] DRY RUN 모드 구현
- [x] 백업 기능 구현
- [x] 로깅 기능 구현

### Phase 3: 소규모 테스트 (예정)
- [ ] 10명 선별
- [ ] DRY RUN 실행
- [ ] 결과 검증
- [ ] 실제 실행
- [ ] 결과 모니터링

### Phase 4: 중규모 실행 (예정)
- [ ] 50명 선별
- [ ] 배치 처리 실행
- [ ] 결과 확인

### Phase 5: 대규모 실행 (예정)
- [ ] 나머지 모든 고객 처리
- [ ] 진행 상황 모니터링

### Phase 6: 검증 (예정)
- [ ] 전체 재확인
- [ ] UI 확인
- [ ] 최종 보고서 작성

---

## 16. 다음 단계

1. **전체 고객 재확인**: 2,993명 모두 확인하여 정확한 통계 수집
2. **소규모 테스트**: 10명 고객으로 안전성 검증
3. **단계별 실행**: 검증된 후 점진적 확대

---

**작성자**: AI Assistant  
**최종 수정일**: 2026-01-28  
**버전**: 1.0
