# 슈파베이스 스토리지 이미지 삭제 문제 분석

## 🔍 발견된 주요 문제점

### 1. **파일 경로 불일치 문제**
- **문제**: 폴더 경로가 포함된 파일명과 실제 스토리지 경로가 일치하지 않음
- **원인**: `delete-image.js`에서 복잡한 파일 검색 로직이 있지만, 실제 삭제 시에는 단순한 경로 사용
- **영향**: 폴더 내 이미지 삭제 실패

### 2. **메타데이터 삭제 불완전**
- **문제**: `image_metadata` 테이블에서 `file_name`으로만 검색하여 삭제
- **원인**: `like` 연산자 사용으로 정확한 매칭 실패
- **영향**: 고아 메타데이터 레코드 생성

### 3. **삭제 검증 로직 부족**
- **문제**: 삭제 후 실제로 파일이 삭제되었는지 확인하지 않음
- **원인**: Supabase Storage API 응답만으로 성공 판단
- **영향**: 삭제 실패 시에도 성공으로 처리

## 🚨 구체적인 문제 사례

### Case 1: 폴더 내 이미지 삭제 실패
```javascript
// 문제가 되는 코드 (delete-image.js:303)
const { data, error } = await supabase.storage
  .from('blog-images')
  .remove([targetWithExtension]); // 폴더 경로가 포함된 파일명

// 실제 스토리지에서는 다른 경로에 있을 수 있음
```

### Case 2: 메타데이터 삭제 실패
```javascript
// 문제가 되는 코드 (delete-image.js:320)
.delete()
.like('file_name', `%${targetWithExtension}%`); // LIKE 연산자로 부정확한 매칭
```

### Case 3: 삭제 검증 부족
```javascript
// 현재 코드에서는 삭제 후 검증이 없음
if (error) {
  // 에러 처리만 하고 실제 삭제 여부 확인 안함
}
```

## 🔧 해결 방안

### 1. **정확한 파일 경로 매칭**
```javascript
// 개선된 파일 경로 검색
const findActualFilePath = async (targetPath) => {
  // 1. 정확한 경로로 시도
  // 2. 폴더별 검색
  // 3. 전체 검색 후 매칭
  // 4. URL 기반 검증
};
```

### 2. **메타데이터 정확한 삭제**
```javascript
// 개선된 메타데이터 삭제
const deleteMetadata = async (filePath, imageUrl) => {
  // 1. file_name으로 정확한 매칭
  // 2. image_url로 매칭
  // 3. 둘 다 시도하여 확실한 삭제
};
```

### 3. **삭제 검증 강화**
```javascript
// 삭제 후 검증 로직
const verifyDeletion = async (filePath) => {
  // 1. HEAD 요청으로 파일 존재 확인
  // 2. 스토리지 list로 재확인
  // 3. 메타데이터 존재 확인
};
```

## 📊 영향도 분석

### 높은 우선순위
- **폴더 내 이미지 삭제**: 사용자 경험에 직접적 영향
- **메타데이터 고아 레코드**: 데이터베이스 정합성 문제

### 중간 우선순위
- **삭제 검증 부족**: 디버깅 어려움
- **에러 처리 미흡**: 사용자 피드백 부족

## 🎯 권장 수정 사항

### 1. **즉시 수정 필요**
- [ ] 파일 경로 매칭 로직 개선
- [ ] 메타데이터 삭제 정확성 향상
- [ ] 삭제 검증 로직 추가

### 2. **단기 개선**
- [ ] 에러 메시지 상세화
- [ ] 로깅 강화
- [ ] 사용자 피드백 개선

### 3. **장기 개선**
- [ ] 삭제 API 통합
- [ ] 트랜잭션 처리
- [ ] 롤백 메커니즘

## 🔍 테스트 케이스

### 테스트 시나리오
1. **루트 폴더 이미지 삭제**
2. **하위 폴더 이미지 삭제**
3. **일괄 삭제 (혼합 경로)**
4. **메타데이터 연동 삭제**
5. **삭제 실패 시나리오**

### 예상 결과
- 모든 케이스에서 100% 삭제 성공
- 메타데이터 완전 삭제
- 명확한 에러 메시지 제공
