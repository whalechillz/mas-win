# 고객 이미지 Storage 동기화 계획

## 배경

이남구 고객에서 발견된 문제:
- **DB에 24개 이미지 메타데이터** vs **Storage에 11개 실제 파일**
- **중복 이미지**: 같은 `filename`이 여러 번 등록됨 (최대 4개 중복)
- **고스트 이미지**: Storage에 실제 파일이 없는 DB 메타데이터

이 문제가 다른 고객들에게도 존재할 가능성이 높습니다.

## 목표

1. 모든 고객의 이미지 동기화 상태 확인
2. 고스트 이미지 및 중복 이미지 발견
3. Storage와 DB 메타데이터 일치시키기
4. 불필요한 썸네일/리사이즈 파일 정리

## 문제 유형

### 1. 고스트 이미지 (Ghost Images)
- **정의**: DB에 메타데이터는 있지만 Storage에 실제 파일이 없는 이미지
- **원인**: 
  - 파일이 삭제되었지만 DB 메타데이터가 남아있음
  - `file_path`가 잘못되어 실제 파일과 매칭되지 않음
- **영향**: 고객 관리에서 이미지 로드 실패, 잘못된 이미지 개수 표시

### 2. 중복 이미지 (Duplicate Images)
- **정의**: 같은 `filename`을 가진 여러 개의 DB 메타데이터
- **원인**:
  - 이미지 업로드 시 중복 등록
  - 마이그레이션 과정에서 중복 생성
- **영향**: 고객 관리에서 이미지 개수가 실제보다 많게 표시

### 3. 썸네일/리사이즈 파일
- **정의**: Storage에 존재하지만 원본 파일이 아닌 생성된 파일
- **원인**: 이미지 처리 과정에서 자동 생성
- **영향**: Storage 용량 낭비

## 실행 계획

### Phase 1: 전체 현황 파악 (1일차)

**목표**: 모든 고객의 이미지 동기화 상태 확인

**작업**:
1. ✅ 스크립트 작성: `check-all-customers-ghost-images.js`
2. 전체 고객 스캔 실행
3. 문제가 있는 고객 목록 및 통계 생성
4. 보고서 생성: `customer-ghost-images-report.json`

**예상 결과**:
- 문제가 있는 고객 수
- 총 고스트 이미지 수
- 총 중복 이미지 수
- 문제 유형별 분류 (고스트만, 중복만, 둘 다)

### Phase 2: 일괄 정리 스크립트 작성 (1일차)

**목표**: 안전하게 고스트 이미지 및 중복 이미지 삭제

**작업**:
1. ✅ 스크립트 작성: `sync-all-customers-images.js`
2. DRY RUN 모드로 검증
3. 백업 계획 수립

**기능**:
- 각 고객별로:
  - Storage 실제 파일 확인
  - DB 이미지와 매칭
  - filename별로 가장 최근 것만 유지
  - 고스트 이미지 삭제
  - 중복 이미지 삭제
- 진행 상황 로깅
- 오류 발생 시 롤백 가능하도록 ID 기록

### Phase 3: 단계별 실행 (2일차)

**전략**: 위험을 최소화하기 위해 단계별 실행

#### 3-1. 소규모 테스트 (10명)
- 문제가 적은 고객 10명 선별
- DRY RUN 후 실제 실행
- 결과 검증

#### 3-2. 중규모 실행 (50명)
- 문제가 중간인 고객 50명
- 결과 모니터링

#### 3-3. 대규모 실행 (나머지)
- 나머지 모든 고객
- 배치 처리

### Phase 4: 썸네일/리사이즈 파일 정리 (2일차)

**목표**: Storage 용량 최적화

**작업**:
1. 썸네일/리사이즈 파일 목록 생성
2. 원본 파일과 매칭 확인
3. 원본이 있는 경우에만 썸네일 삭제
4. 원본이 없는 경우 썸네일 보존 (원본 대체)

### Phase 5: 검증 및 모니터링 (3일차)

**작업**:
1. 동기화 후 재확인 스크립트 실행
2. 고객 관리 UI에서 이미지 개수 확인
3. 이미지 로드 실패 확인
4. 문제 발생 시 롤백

## 스크립트 목록

### 확인 스크립트
- ✅ `check-all-customers-ghost-images.js` - 전체 고객 확인
- `check-customer-image-sync.js` - 특정 고객 확인

### 정리 스크립트
- ✅ `delete-leenamgu-duplicate-images.js` - 이남구 고객 정리 (완료)
- `sync-all-customers-images.js` - 전체 고객 일괄 정리
- `sync-customer-images.js` - 특정 고객 정리

### 유틸리티 스크립트
- `backup-image-metadata.js` - DB 메타데이터 백업
- `restore-image-metadata.js` - DB 메타데이터 복원

## 안전장치

1. **DRY RUN 모드**: 모든 스크립트는 기본적으로 시뮬레이션만 수행
2. **백업**: 삭제 전 DB 메타데이터 백업
3. **단계별 실행**: 소규모 → 중규모 → 대규모
4. **로깅**: 모든 삭제 작업 로그 기록
5. **롤백**: 삭제된 이미지 ID 기록으로 복원 가능

## 예상 효과

### 정량적 효과
- **고스트 이미지 제거**: DB 용량 최적화
- **중복 이미지 제거**: 정확한 이미지 개수 표시
- **Storage 용량 절감**: 불필요한 썸네일 제거

### 정성적 효과
- **데이터 일관성**: Storage와 DB 동기화
- **사용자 경험 개선**: 정확한 이미지 개수, 로드 실패 감소
- **유지보수성 향상**: 깨끗한 데이터베이스

## 리스크 및 대응

### 리스크
1. **실제 파일이 있는데 고스트로 판단**: 파일명 매칭 오류
2. **중요 이미지 삭제**: 잘못된 중복 판단
3. **대량 삭제로 인한 DB 부하**: 성능 저하

### 대응
1. **엄격한 매칭 로직**: 파일명, 경로, 크기 등 다중 검증
2. **보수적 접근**: 확실한 경우만 삭제, 의심스러우면 보존
3. **배치 처리**: 한 번에 너무 많이 삭제하지 않음
4. **백업 및 롤백**: 문제 발생 시 즉시 복원

## 실행 일정

- **1일차**: 현황 파악 및 스크립트 작성 ✅
- **2일차**: 단계별 실행 및 썸네일 정리
- **3일차**: 검증 및 모니터링

## 확인 결과 (2026-01-28)

### 전체 현황
- **총 고객 수**: 1,000명
- **문제가 있는 고객**: 16명 (1.6%)
- **유효한 이미지**: 280개
- **고스트 이미지**: 72개
- **중복 이미지**: 21개

### 문제가 있는 고객 TOP 5
1. **이경희** (minhosik-5549): 고스트 21개, 중복 2개
2. **김석구** (kimseokgu-6302): 고스트 9개, 중복 1개
3. **박승조** (kimbothyeon-4648): 고스트 9개
4. **김용석** (kimyotseok-4453): 고스트 8개
5. **박성우** (parksungwoo-6003): 고스트 4개, 중복 3개

### 문제 유형별 통계
- **고스트만**: 10명
- **중복만**: 3명
- **둘 다**: 3명

## 다음 단계

1. ✅ `check-all-customers-ghost-images.js` 실행 완료
2. ✅ `sync-all-customers-images.js` 작성 완료
3. **다음**: 소규모 테스트 실행 (10명)
4. 결과 검증 후 대규모 실행

## 실행 방법

### 1. 전체 현황 확인 (재실행)
```bash
node scripts/check-all-customers-ghost-images.js
```

### 2. 동기화 실행 (DRY RUN)
```bash
node scripts/sync-all-customers-images.js
```

### 3. 동기화 실행 (실제)
```bash
# 기본 배치 크기 (10명씩)
node scripts/sync-all-customers-images.js --execute

# 작은 배치 크기 (5명씩, 더 안전)
node scripts/sync-all-customers-images.js --execute --batch=5
```
