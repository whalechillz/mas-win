# 이미지 메타데이터 편집 모달 수정 계획서

**작성일**: 2026-01-29  
**대상**: 고객정보 · 갤러리 관리 공통 이미지 메타데이터 편집 모달

---

## 1. 모달 동일 여부

| 구분 | 사용 위치 | 컴포넌트 | 결론 |
|------|-----------|----------|------|
| 고객정보 – 이미지 메타데이터 편집 | `pages/admin/customers/index.tsx` | `ImageMetadataModal` | **동일** |
| 갤러리 관리 – 이미지 메타데이터 편집 | `pages/admin/gallery.tsx` | `ImageMetadataModal` | **동일** |

- 두 화면 모두 **동일 컴포넌트** `components/ImageMetadataModal/index.tsx`를 사용합니다.
- 따라서 레이아웃·버튼·필드·동작은 같고, 열리는 페이지(고객 정보 vs 갤러리)만 다릅니다.

---

## 2. 갤러리 관리 모달 상단 버튼이 2줄로 나오는 원인

### 원인

- 모달 헤더가 `flex justify-between`으로 **좌(제목+파일명) / 우(버튼 그룹)** 로 나뉘어 있음.
- 모달 폭이 `max-w-4xl`(896px)로 제한되어 있고, 좌측 제목·파일명이 길어지면 **우측 버튼 영역 가로 공간**이 줄어듦.
- 버튼 컨테이너에 `flex-wrap`이 없어도, 공간이 부족하면 플렉스 아이템이 **자연스럽게 줄바꿈**되거나, 뷰포트/모달이 좁을 때 4개 버튼이 한 줄에 다 들어가지 않아 **두 줄로 보이는 현상**이 발생함.

### 수정 방향 (반영 완료)

1. **헤더 레이아웃**
   - 제목 영역: `min-w-0 flex-1`로 너비 제한을 주어, 버튼 영역이 일정 폭 이상 확보되도록 함.
   - 파일명: `truncate` + `title`로 길면 말줄임만 하고, 버튼 쪽 공간을 덜 차지하게 함.
2. **버튼 영역**
   - `flex-nowrap flex-shrink-0`로 **한 줄 고정**.
   - 공간이 부족할 때는 `overflow-x-auto`로 **가로 스크롤**만 되도록 해, 2줄로 줄바꿈되지 않게 함.

### 변경 파일

- `components/ImageMetadataModal/index.tsx`  
  - 헤더: `justify-between gap-4`, 제목 영역 `min-w-0 flex-1`, 파일명 `truncate`  
  - 버튼 컨테이너: `flex-nowrap flex-shrink-0 overflow-x-auto`

---

## 3. (참고) 기타 이슈와의 관계

- **메타데이터 저장 500 (categories is not defined)**  
  - `pages/api/admin/image-metadata.js` 측 수정 사항이며, 모달 UI와는 별개입니다.  
  - 모달은 동일 컴포넌트이므로, 갤러리/고객정보 모두 저장 API 수정 후 동일하게 동작합니다.
- **OCR 스캔 / fullTextAnnotation**  
  - 고객 이미지 업로드 플로우(`create-customer-image-metadata`) 쪽 수정 사항이며, 이 모달의 “OCR 스캔” 버튼과는 다른 경로입니다.

---

## 4. OCR 문구 중복 제거 (2026-01-29 반영)

### 현상

- 모달 상단/카드에 **"OCR 문서 편집 모드"**, DocumentOCRViewer 내부에 **"OCR 문서 편집"** 이 비슷한 의미로 중복 표시됨.

### 수정 내용

| 위치 | 변경 전 | 변경 후 |
|------|---------|---------|
| 문서 뷰어 상단 바 (모달) | OCR 문서 편집 모드 | **문서 뷰어** |
| 메인 폼 내 파란 카드 제목 | 📄 OCR 문서 편집 모드 | **📄 문서 뷰어** |
| DocumentOCRViewer 헤더 | OCR 문서 편집 | 유지 (해당 뷰의 제목으로만 사용) |

- "문서 뷰어"는 **모드 전환/안내**용, "OCR 문서 편집"은 **뷰어 화면 내 제목**으로 한 번만 사용하도록 정리.

### 변경 파일

- `components/ImageMetadataModal/index.tsx`  
  - 문서 뷰어 상단 바 문구: `OCR 문서 편집 모드` → `문서 뷰어`  
  - 메인 폼 내 카드 제목: `📄 OCR 문서 편집 모드` → `📄 문서 뷰어`

---

## 5. 문서 뷰어 모드로 모달 닫은 후 일반 이미지 클릭 시 메타데이터 미표시 (2026-01-29 반영)

### 현상

- 문서 뷰어 모드에서 모달을 닫고, **문서가 아닌 일반 이미지**를 클릭하면  
  메타데이터 입력 필드/문서 뷰어가 보이지 않고 **상단 버튼만** 보이는 빈 화면이 됨.

### 원인

- `showDocumentViewer` 상태가 **모달을 닫아도 초기화되지 않음**.
- 문서 이미지에서 "문서 뷰어로 보기" 클릭 → `showDocumentViewer = true`.
- 모달 닫기 → 다른 이미지(일반 이미지) 클릭 → 모달이 새 이미지로 다시 열림.
- 이때 **이미지 변경에 따라 폼만 초기화**되고, `showDocumentViewer`는 **그대로 true**로 유지됨.
- 렌더링 조건:
  - 문서 뷰어: `showDocumentViewer && hasOCRText && ocrText` → 일반 이미지는 OCR 없음 → **false** → 문서 뷰어 미표시.
  - 메인 폼: `!showDocumentViewer` → **false** → 메인 폼도 미표시.
- 결과: 두 영역 모두 조건 불충족으로 **아무 컨텐츠도 렌더되지 않음** (버튼만 보임).

### 수정 내용

- **이미지가 바뀔 때** (`image`가 변경될 때) 폼 초기화와 함께 **`showDocumentViewer`를 false로 초기화**.
- `components/ImageMetadataModal/index.tsx` 의 `useEffect(() => { if (image) { ... setForm(newForm); ... } }, [image]);` 안에  
  `setShowDocumentViewer(false);` 추가.

### 변경 파일

- `components/ImageMetadataModal/index.tsx`  
  - `image` 의존 useEffect 내, `setValidationErrors({});` 다음에 `setShowDocumentViewer(false);` 추가.

---

## 6. "문서 뷰어로 보기" 클릭 시 빈 화면 (2026-01-29 반영)

### 현상

- 문서/이미지 파일 업로드 → 이미지 메타데이터 편집 모달에서 **OCR 스캔** 실행 → 추출 완료(설명 필드에 OCR 텍스트 입력) 후  
  **"문서 뷰어로 보기"** 버튼을 눌러도 문서 뷰어(원본 이미지 + OCR 텍스트 나란히 보기)가 나오지 않고, **콘텐츠 영역이 비어 있는 화면**만 보임.

### 원인

1. **OCR 스캔 완료 시 `ocrText` 미설정**  
   - OCR 결과를 반영할 때 **`description`만** `[OCR 추출 텍스트]\n${ocrResult.text}` 로 설정하고,  
     문서 뷰어에서 사용하는 **`(form as any).ocrText`** 는 설정하지 않음.
2. **문서 뷰어 렌더 조건**  
   - 문서 뷰어 블록은 `showDocumentViewer && hasOCRText && (form as any).ocrText` 일 때만 렌더됨.  
   - "문서 뷰어로 보기" 클릭 → `showDocumentViewer = true`, `hasOCRText`는 description에 OCR 마커/긴 텍스트가 있어 **true**,  
     하지만 **`(form as any).ocrText`** 는 undefined → **조건 불충족** → 문서 뷰어 미렌더.
3. **메인 폼도 미표시**  
   - 메인 폼은 `!showDocumentViewer` 일 때만 표시되므로, `showDocumentViewer === true` 인 상태에서는 메인 폼도 안 나옴.  
   - 결과: 문서 뷰어·메인 폼 둘 다 안 나와 **빈 콘텐츠 영역**만 보임.

### 수정 내용

1. **OCR 스캔 완료 시 `ocrText` 함께 설정**  
   - `setForm` 시 `description`뿐 아니라 **`ocrText: ocrResult.text`** 도 설정하여, "문서 뷰어로 보기" 클릭 시 문서 뷰어가 정상 표시되도록 함.
2. **문서 뷰어 표시 조건 완화**  
   - `(form as any).ocrText` 가 없어도, **description에서 `[OCR 추출 텍스트]` 마커를 제거한 텍스트**가 있으면 문서 뷰어를 표시하도록 조건 변경.  
   - `showDocumentViewer && hasOCRText && ((form as any).ocrText || (form.description && form.description.replace(/^\[OCR 추출 텍스트\]\n?/, '').trim()))`

### 변경 파일

- `components/ImageMetadataModal/index.tsx`  
  - OCR 스캔 성공 시: `setForm`에 `ocrText: ocrResult.text`(또는 동일 의미의 spread) 추가.  
  - 문서 뷰어 블록 조건: `(form as any).ocrText` 만이 아니라, description 기반 파생 텍스트도 허용하도록 수정.

---

## 7. 체크리스트

- [x] 고객정보/갤러리 모달이 같은 컴포넌트인지 확인
- [x] 상단 버튼 2줄 원인 분석 (헤더 공간 부족)
- [x] 버튼 한 줄 유지 + 가로 스크롤 처리
- [x] OCR 문구 중복 제거 (문서 뷰어 / OCR 문서 편집)
- [x] 이미지 변경 시 문서 뷰어 상태 초기화 (일반 이미지 클릭 시 빈 화면 방지)
- [x] "문서 뷰어로 보기" 클릭 시 빈 화면 → OCR 결과에 ocrText 설정 및 표시 조건 완화
- [ ] (선택) 작은 뷰포트에서 버튼 텍스트 축약 또는 아이콘만 보이기 등 추가 반응형 개선

---

## 8. 요약

| 항목 | 내용 |
|------|------|
| 모달 동일 여부 | 고객정보 · 갤러리 모두 **동일** `ImageMetadataModal` 사용 |
| 2줄 원인 | 헤더 좌측이 넓어져 버튼 영역 가로 공간 부족 → 줄바꿈 |
| 상단 버튼 수정 | 제목 영역 축소·말줄임, 버튼 영역 `flex-nowrap` + `overflow-x-auto`로 한 줄 유지 |
| OCR 문구 중복 | "OCR 문서 편집 모드" → "문서 뷰어"로 통일, 뷰어 내부만 "OCR 문서 편집" 유지 |
| 빈 화면 버그(이미지 전환) | 문서 뷰어 모드로 닫은 뒤 일반 이미지 클릭 시 `showDocumentViewer` 미초기화 → 이미지 변경 시 `setShowDocumentViewer(false)` 추가 |
| 빈 화면 버그(문서 뷰어로 보기) | OCR 스캔 후 ocrText 미설정 + 표시 조건이 ocrText 필수 → OCR 결과에 ocrText 설정 및 description 기반 표시 조건 완화 |
