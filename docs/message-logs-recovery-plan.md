# Message Logs 복구 계획 및 실행 결과

## 📊 문제 현황

### 발견된 문제
- **기록률**: 23.66% (총 2,544명 중 602건만 기록)
- **누락 메시지**: 25건
- **영향**: 고객 메시지 이력이 제대로 표시되지 않음

### 원인 분석
1. **발송 로직 변경**: 과거 발송 로직에서 `message_logs` 기록이 누락됨
2. **실패 메시지**: `failed` 상태 메시지는 기록되지 않음
3. **테스트 메시지**: 일부 테스트 발송이 기록되지 않음

## 🔧 복구 작업

### 1단계: 현황 파악
- **스크립트**: `scripts/check-message-logs-coverage.js`
- **결과**: 
  - 총 29건의 sent/partial 상태 메시지 확인
  - 25건의 메시지에 기록 누락 발견

### 2단계: 개별 복구 (117번 메시지)
- **스크립트**: `scripts/recover-message-117-logs.js`
- **대상**: 010-4914-8478 번호 포함 메시지
- **결과**: 102건 복구 완료

### 3단계: 전체 복구
- **스크립트**: `scripts/recover-all-missing-messages.js`
- **대상**: 모든 누락된 메시지
- **결과**:
  - ✅ 32건 복구 완료
  - 📊 1,764건의 로그 복구
  - 📈 기록률: 23.66% → 85.99%

## 📈 복구 결과

### 복구 전
- 총 수신자: 2,544명
- 총 기록: 602건
- 기록률: 23.66%

### 복구 후
- 총 수신자: 2,870명
- 총 기록: 2,468건
- 기록률: 85.99%

### 복구된 메시지 ID
119, 118, 127, 99, 126, 125, 124, 116, 123, 122, 121, 120, 115, 113, 114, 112, 108, 107, 95, 94, 93, 92, 101, 90, 81, 86, 80, 78, 72, 69, 64, 66

## 🔍 남은 문제

### 기록률 85.99%인 이유
1. **부분 기록**: 일부 메시지는 일부 수신자만 기록됨
2. **recipient_numbers 부재**: 일부 메시지는 `recipient_numbers`가 없어 복구 불가
3. **솔라피 동기화**: 솔라피 API에서 실제 발송 결과와 차이가 있을 수 있음

## 🛠️ 향후 개선 방안

### 1. 발송 로직 개선
- **위치**: `pages/api/channels/sms/send.js`
- **개선사항**:
  - 발송 실패 시에도 `message_logs` 기록
  - 에러 발생 시에도 로그 기록 보장
  - `recipient_numbers`와 `message_logs` 동기화 강화

### 2. 정기 동기화
- **스크립트**: `scripts/sync-solapi-message-to-db.js` (기존)
- **개선사항**:
  - 정기적으로 솔라피 API와 동기화
  - 누락된 로그 자동 복구

### 3. 모니터링
- **스크립트**: `scripts/check-message-logs-coverage.js`
- **사용법**: 정기적으로 실행하여 기록률 모니터링
- **목표**: 기록률 95% 이상 유지

## 📝 사용 가이드

### 기록률 확인
```bash
node scripts/check-message-logs-coverage.js
```

### 개별 메시지 복구
```bash
# 특정 메시지 ID 복구
node scripts/recover-message-117-logs.js
```

### 전체 복구
```bash
# 모든 누락 메시지 복구
node scripts/recover-all-missing-messages.js
```

### 특정 번호 확인
```bash
# 고객 메시지 이력 확인
node scripts/test-customer-messages-api.js 010-4914-8478
```

## ✅ 검증

### 010-4914-8478 번호 검증
- **117번 메시지**: ✅ 복구 완료 (failed 상태)
- **API 테스트**: ✅ 메시지 이력 정상 표시 확인 필요

## 📌 참고사항

1. **복구 방법**: `recipient_numbers` 기반으로 복구
2. **상태 처리**: `failed` 상태는 `failed`로, `sent/partial`은 `sent`로 기록
3. **중복 방지**: `upsert` 사용으로 중복 기록 방지
4. **성능**: 대량 복구 시 시간이 소요될 수 있음

## 🎯 목표

- **단기**: 기록률 90% 이상 달성
- **중기**: 발송 로직 개선으로 100% 기록 보장
- **장기**: 솔라피 API와 실시간 동기화


