# SMS 청크 발송 및 Solapi 로그 확인 방법 (2025-11-18)

## 문제 상황

**증상:**
- 1309명에게 SMS 발송 시도
- Solapi 콘솔에 "총 200건 발송요청완료"만 표시됨
- 나머지 1109명은 어떻게 발송되는지 불명확

## 원인 분석

### 1. 청크 발송 방식
- Solapi API는 한 번에 최대 200건까지 발송 가능
- 1309명을 발송하려면 **7개 청크**로 나눠서 순차 발송:
  - 청크 1: 1~200번째 (200건)
  - 청크 2: 201~400번째 (200건)
  - 청크 3: 401~600번째 (200건)
  - 청크 4: 601~800번째 (200건)
  - 청크 5: 801~1000번째 (200건)
  - 청크 6: 1001~1200번째 (200건)
  - 청크 7: 1201~1309번째 (109건)

### 2. Solapi 그룹 ID
- **각 청크마다 별도의 그룹 ID가 생성됨**
- Solapi 콘솔에서는 각 그룹을 개별적으로 확인해야 함
- 현재 DB에는 첫 번째 그룹 ID만 저장 (`solapi_group_id`)
- 나머지 그룹 ID는 서버 콘솔 로그에서 확인 가능

## 해결 방법

### 1. 서버 콘솔 로그 확인
발송 시 서버 콘솔에 다음과 같은 로그가 출력됩니다:

```
📤 총 1309건을 7개 청크로 나눠서 발송 시작 (청크 크기: 200건)

============================================================
📤 청크 1/7 발송 시작
   범위: 1번째 ~ 200번째 수신자
   건수: 200건
   진행률: 0% → 15%
============================================================

✅ 청크 1/7 발송 성공!
   그룹 ID: G1234567890
   Solapi 콘솔에서 확인: https://console.solapi.com/message-log

📊 청크 1/7 결과:
   총 시도: 200건
   성공: 195건
   실패: 0건
   발송중: 5건
   누적 성공: 195건 / 누적 실패: 0건

============================================================
📤 청크 2/7 발송 시작
   범위: 201번째 ~ 400번째 수신자
   건수: 200건
   진행률: 15% → 30%
============================================================

✅ 청크 2/7 발송 성공!
   그룹 ID: G1234567891
   ...

... (청크 3~7도 동일하게 진행)

🎉 전체 발송 완료!
============================================================
📊 총 청크 수: 7개
📊 생성된 그룹 수: 7개
📊 최종 집계:
   총 시도: 1309건
   성공: 1300건
   실패: 9건

📋 생성된 그룹 IDs (Solapi 콘솔에서 각각 확인 가능):
   1. G1234567890
   2. G1234567891
   3. G1234567892
   4. G1234567893
   5. G1234567894
   6. G1234567895
   7. G1234567896

💡 참고: Solapi 콘솔(https://console.solapi.com/message-log)에서 각 그룹을 개별적으로 확인할 수 있습니다.
   각 그룹은 약 200건씩 발송되며, 모든 그룹이 순차적으로 발송되었습니다.
============================================================
```

### 2. Solapi 콘솔에서 모든 그룹 확인
1. **Solapi 콘솔 접속:** https://console.solapi.com/message-log
2. **전송요청내역 탭** 클릭
3. **생성일 필터** 설정 (발송한 날짜)
4. **각 그룹을 개별적으로 확인:**
   - 그룹 1: 200건 (1~200번째)
   - 그룹 2: 200건 (201~400번째)
   - 그룹 3: 200건 (401~600번째)
   - 그룹 4: 200건 (601~800번째)
   - 그룹 5: 200건 (801~1000번째)
   - 그룹 6: 200건 (1001~1200번째)
   - 그룹 7: 109건 (1201~1309번째)

### 3. DB에서 발송 결과 확인
`channel_sms` 테이블에서 다음 필드를 확인:
- `sent_count`: 실제 발송 시도 건수 (1309건)
- `success_count`: 성공 건수
- `fail_count`: 실패 건수
- `solapi_group_id`: 첫 번째 그룹 ID만 저장 (참고용)

## 개선 사항 (향후)

### 1. 모든 그룹 ID 저장
현재는 첫 번째 그룹 ID만 저장되지만, 향후 모든 그룹 ID를 저장하도록 개선 가능:
- `solapi_group_ids` JSON 배열 필드 추가
- 또는 별도 테이블 `sms_solapi_groups` 생성

### 2. UI에서 모든 그룹 표시
- 발송 결과 페이지에서 모든 그룹 ID를 표시
- 각 그룹 ID를 클릭하면 Solapi 콘솔로 이동

### 3. 자동 그룹 상태 동기화
- `refresh=true` 파라미터로 모든 그룹의 상태를 Solapi에서 가져와서 업데이트

## 참고 사항

### 청크 발송 로직 (`pages/api/channels/sms/send.js`)
```javascript
// 200건씩 청크 전송
const chunkSize = 200;
const totalChunks = Math.ceil(allMessages.length / chunkSize);

for (let i = 0; i < allMessages.length; i += chunkSize) {
  const chunkIndex = Math.floor(i / chunkSize) + 1;
  const chunk = allMessages.slice(i, i + chunkSize);
  
  // 각 청크를 Solapi에 발송
  const resp = await fetch('https://api.solapi.com/messages/v4/send-many/detail', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeaders },
    body: JSON.stringify({ messages: chunk })
  });
  
  // 그룹 ID 저장
  const groupId = json.groupInfo?.groupId;
  if (groupId) {
    aggregated.groupIds.push(groupId);
  }
  
  // 다음 청크로 진행 전 0.1초 대기 (API 레이트 리밋 방지)
  if (chunkIndex < totalChunks) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}
```

### 중복 발송 방지
- `message_logs` 테이블을 사용하여 동일 `content_id`로 이미 발송된 번호는 제외
- 수신거부(Opt-out) 고객도 자동으로 제외

## 결론

**모든 메시지가 발송됩니다!**
- 1309명 모두 7개 청크로 나눠서 순차 발송됨
- 각 청크는 별도의 그룹 ID로 생성됨
- Solapi 콘솔에서 각 그룹을 개별적으로 확인 가능
- 서버 콘솔 로그에서 모든 그룹 ID 확인 가능


