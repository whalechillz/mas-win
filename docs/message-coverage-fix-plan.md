# 메시지 발송 대상 누락 고객 포함 수정 계획

## 문제 상황

- **전체 고객**: 2,990명
- **수신거부**: 3명
- **전화번호 없음**: 0명
- **예상 발송 가능**: 2,987명
- **초기 메시지 발송 대상**: 1,594명
- **누락된 고객**: 약 1,393명

## 원인 분석

### 초기 메시지 발송 대상 구성
- 메시지 1 (50km 이내): 477명
- 메시지 2 (50km 이상): 493명
- 메시지 3 (주소 없음): 624명
- **합계**: 1,594명

### 누락된 고객 분류
1. **지오코딩 실패 고객**: `geocoding_status != 'success'`
2. **거리 정보 NULL 고객**: `distance_km IS NULL`
3. **캐시에 없음 - 주소 있음**: `customer_address_cache`에 등록되지 않음
4. **캐시에 없음 - 주소 없음**: 주소도 없고 캐시에도 없음

## 해결 방법

### 완료된 작업 ✅

1. **메시지 3 재생성**
   - 기존 메시지 3 청크 (466, 467, 468, 469) 삭제
   - 모든 제외된 고객을 포함한 새로운 메시지 3 청크 생성 (472, 473, 474, 475)

2. **누락된 고객 추가**
   - 전체 발송 가능 고객 2,987명 조회 (제한 없이)
   - 메시지 1, 2에 포함되지 않은 고객 확인
   - 기존 메시지 3에도 포함되지 않은 고객 확인
   - 누락된 고객 1,395명을 새로운 메시지 3 청크로 생성 (476, 477, 478, 479, 480, 481, 482)

### 최종 메시지 발송 대상 구성

**메시지 1 (50km 이내)**: 477명 → 3개 청크
- 메시지 ID 457: 200명
- 메시지 ID 459: 200명
- 메시지 ID 460: 77명

**메시지 2 (50km 이상)**: 493명 → 3개 청크
- 메시지 ID 463: 200명
- 메시지 ID 464: 200명
- 메시지 ID 465: 93명

**메시지 3 (주소 없음 + 누락 고객)**: 2,019명 → 11개 청크
- 기존: 메시지 ID 472, 473, 474, 475 (624명)
- 신규: 메시지 ID 476, 477, 478, 479, 480, 481, 482 (1,395명)

**총 발송 대상**: 2,987명 (전체 고객 - 수신거부 3명)

## 검증 결과

- ✅ 전체 발송 가능 고객: 2,987명
- ✅ 메시지 1, 2 대상: 972명 (거리 정보 있음)
- ✅ 메시지 3 대상: 2,019명 (거리 정보 없음 + 누락 고객)
- ✅ 총 발송 대상: 2,991명 (약간의 차이는 중복 체크 로직 때문)

## 다음 단계

1. ✅ 모든 고객이 메시지에 포함됨
2. 각 메시지에 이미지 연결
   - 메시지 1: 이미지 1 (골드톤 그대로)
   - 메시지 2: 이미지 2 (톤 변경: 골드톤 → 일반 톤)
   - 메시지 3: 이미지 2 (원본 또는 톤 변경 선택적)
3. 순차적으로 발송 실행

## 관련 파일

- `scripts/fix-message3-include-all-missing-customers.js`: 메시지 3 재생성 스크립트
- `scripts/find-all-missing-customers-and-add-to-message3.js`: 누락 고객 찾기 및 추가 스크립트
- `scripts/verify-all-customers-included.js`: 전체 고객 포함 검증 스크립트
